
<!-- README.md is generated from README.Rmd. Please edit that file -->

# mzrtsim

<!-- badges: start -->

<!-- badges: end -->

The goal of mzrtsim is to make batch effects simulation for LC/GC-MS
based peaks list data

## Installation

You can install the released version of mzrtsim from
[CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("mzrtsim")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("yufree/mzrtsim")
```

## Batch effect simulation

You could use `mzrtsim` to make simulation.

``` r
library(mzrtsim)
simdata <- mzrtsim(npeaks = 1000, ncomp = 0.9, ncond = 2, ncpeaks = 0.05,
  nbatch = 3, nbpeaks = 0.1, npercond = 10, nperbatch = c(8, 5, 7),
  shape = 2, scale = 3, shapersd = 1, scalersd = 0.18, seed = 42)
```

Here we make a simulation of 1000 peaks with two conditions and three
batches. 5 percentage of the peaks were influnced by conditions and 10
percentage of the peaks were influnced by batch effects. The parameters
for Weibull distribution of sample mean are 2 for the shape and 3 for
the scale. The parameters for Weibull distribution of sample relative
standard deviation(RSD%) are 1 for the shape and 0.18 for the scale.
Three different type could be simulated: monotonic, random and block.
You could also bind batchtype, for example, ‘mb’ means the simulation
would contain both monotonic and block batch effects.

We use `ncomp` to control the percentage of indenpendent peaks. 0.9
means 900 compounds generated those 1000 peaks. Other peaks would be
randomly generated by the intensity of those 900 original peaks multiple
an exponential of random numbers(normal distribution with mean 0 and
standard deviation 1). Such setting is used for the simulation of peaks
from same compounds in GC/LC-MS data. The conditions and batch effects
would show influnces at peaks level to simulate variances before and
after instruments analysis.

You could also use `simmzrt` to make simulation from real data. Two type
could be used: `e` means simulation from data by sample mean and rsd
from Empirical Cumulative Distribution and `f` means simulation from
data by sample mean and rsd from Bootstrap sampling. The input data
should be matrix with row peaks and column samples.

``` r
simrealdata <- simmzrt(data, type = "e", npeaks = 1000, ncomp = 0.5, ncond = 2,
  ncpeaks = 0.05, nbatch = 3, nbpeaks = 0.1, npercond = 10,
  nperbatch = c(8, 5, 7), seed = 42)
```

You could save the simulated data into multiple csv files by `simdata`
function. `simraw.csv` could be used for metaboanalyst. `simraw2.csv`
show the raw peaks list. `simcon.csv` show peaks influnced by conditions
only.`simbatchmatrix.csv` show peaks influnced by batch effects only.
`simbat.csv` show peaks influnced by batch effects and conditions.
`simcomp.csv` show independent peaks influnced by conditions and batch
effects. `simcompchange.csv` show the conditions changes of each groups.
`simblockbatchange.csv` show the block batch changes of each groups.
`simmonobatchange.csv` show the monotonic batch changes of each groups.

``` r
simdata(sim,name = "sim")
```

## Basic models of batch effects correction

Batch effects are the variances caused by factor other than the
experimental design. We could simply make a linear model for the
intensity of one peak:

\[Intensity =  Average + Condition + Batch + Error\]

Research is focused on condition contribution part and overall average
or random error could be estimated. However, we know little about the
batch contribution. Sometimes we could use known variables such as
injection order or operators as the batch part. However, in most cases
we such variable is unknown. Almost all the batch correction methods are
trying to use some estimations to balance or remove the batch effect.

For analytical chemistry, internal standards or pool quality control
samples are actually standing for the batch contribution part in the
model. However, it’s impractical to get all the internal standards when
the data is collected untargeted. For methods using internal standards
or pool quality control samples, the variations among those samples are
usually removed as median, quantile, mean or the ratios. Other ways like
quantile regression, centering and scaling based on distribution within
samples could be treated as using the stable distribution of peaks
intensity to remove batch effects. However, here we would turn to the
experiments without pooled quality control samples and correction
methods which make estimation of batch effects. Some combination methods
using pooled quality control samples or control samples to estimate the
batch effect like Remove Unwanted Variation(RUV) would not be covered
here.

### Distribution of intensity

Intensity collects from LC/GC-MS always showed a right-skewed
distribution. Log transformation is often necessary for further
statistical analysis. In some case, a Log-transformed intensity could be
visualized easily.

## Evaluation of batch correction

Various methods have been used for batch correction and evaluation. For
our simulation, we need some methods to check the performances of
correction. Difference analysis would be a common method for evaluation.
Then we could check whether this peak is true positive or false positive
by settings of the simulation.
